---
title: "Data Wrangling"
author: "Iris Zhong"
date: "12/14/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(readxl)
# library(readxlsb)
library(tidyverse)
```

```{r import data}
data_2020 <- read_excel(here("data/xlsx", "2020-21 Professional Personnel Individual Staff Report updated.xlsx")) %>% mutate(PublicID = as.numeric(PublicID))

data_2014 <- read_excel(here("data/xlsx", "2014-15 Professional Personnel Individual Staff Report.xlsx"))

data_2015 <- read_excel(here("data/xlsx", "2015-16 Professional Personnel Individual Staff Report.xlsx"))

data_2016 <- read_excel(here("data/xlsx", "2016-17 Professional Personnel Individual Staff Report.xlsx"))

data_2017 <- read_excel(here("data/xlsx", "2017-18 Professional Personnel Individual Staff Report.xlsx"))

data_2018 <- read_excel(here("data/xlsx", "2018-19 Professional Personnel Individual Staff Report.xlsx"))

data_2019 <- read_excel(here("data/xlsx", "2019-20 Professional Personnel Individual Staff Report.xlsx"))

```

# Exploration (don't run)



```{r use name as ID, include = F}
data_2014_clean <- data_2014 %>%
  unite("name", c(`First Name`, `MiddleName`, `Last Name`, Suffix), sep=" ", 
        remove = FALSE, na.rm = TRUE) %>%
  mutate(name = tolower(name)) %>%
  mutate(person_ID = group_indices(., name))
```



Doesn't work well 

```{r include = F}
data_2014_clean %>%
  group_by(person_ID, PublicID) %>%
  summarize(n = n()) %>%
  filter(n != 1)
```



```{r include= F}
data_2014_clean %>%
  group_by(person_ID) %>%
  summarize(n = n()) %>%
  filter(n != 1)
```


```{r include = F}
data_2014_clean %>%
  filter(person_ID ==875)
```

Only 2020-21 uses different PublicID. 


```{r include = F}
data_2014 %>%
  inner_join(data_2015, by = c("PublicID")) %>%
  filter(Status.y != "Active")
```

# Clean 2014-2020 data

Select year and public ID

```{r select func}
select_var <- function(data) {
  
  data <- data %>%
    dplyr::select(SY, PublicID)
  
}
```


```{r apply select func}
data_list <- list(data_2014, data_2015, data_2016, data_2017, data_2018, data_2019, data_2020)

temp <- lapply(data_list, function(x){x <- x %>% dplyr::select(SY, PublicID); return (x)})

names(temp) <- c("data_2014_short", "data_2015_short", "data_2016_short", "data_2017_short", "data_2018_short","data_2019_short", "data_2020_short")

list2env(temp, envir = .GlobalEnv)
```

```{r only keep distinct IDs}
data_2014_short <- distinct(data_2014_short, .keep_all = T)
data_2015_short <- distinct(data_2015_short, .keep_all = T)
data_2016_short <- distinct(data_2016_short, .keep_all = T)
data_2017_short <- distinct(data_2017_short, .keep_all = T)
data_2018_short <- distinct(data_2018_short, .keep_all = T)
data_2019_short <- distinct(data_2019_short, .keep_all = T)
data_2020_short <- distinct(data_2020_short, .keep_all = T)
```

Take a look at ID: 180041809 (a lot of rows)


```{r join datasets}
data_14_20_short <- data_2014_short %>%
  full_join(data_2015_short, by = "PublicID") %>%
  full_join(data_2016_short, by = "PublicID") %>%
  full_join(data_2017_short, by = "PublicID") %>%
  full_join(data_2018_short, by = "PublicID") %>%
  full_join(data_2019_short, by = "PublicID") %>%
  full_join(data_2020_short, by = "PublicID")
```


```{r change column names}
data_14_20_short %>% head()

data_14_20_short <- data_14_20_short %>%
  mutate(Y14 = SY.x, Y15 = SY.y, Y16 = SY.x.x,
         Y17 = SY.y.y, Y18 = SY.x.x.x, Y19 = SY.y.y.y, Y20 = SY) %>%
  select(PublicID, Y14:Y20)
```


```{r convert to binary}
data_14_20_short <- data_14_20_short %>%
  mutate(Y14 = ifelse(is.na(Y14) == T, 0, 1),
         Y15 = ifelse(is.na(Y15) == T, 0, 1),
         Y16 = ifelse(is.na(Y16) == T, 0, 1),
         Y17 = ifelse(is.na(Y17) == T, 0, 1),
         Y18 = ifelse(is.na(Y18) == T, 0, 1),
         Y19 = ifelse(is.na(Y19) == T, 0, 1),
         Y20 = ifelse(is.na(Y20) == T, 0, 1))
```



```{r}
sum(data_14_20_short$Y14)
sum(data_14_20_short$Y15)
sum(data_14_20_short$Y16)
sum(data_14_20_short$Y17)
sum(data_14_20_short$Y18)
sum(data_14_20_short$Y19)
sum(data_14_20_short$Y20)
```


# Years of experience + drop out

```{r}
data_14_20_short <- data_14_20_short %>%
  mutate(state = paste(Y14, Y15, Y16, Y17, Y18, Y19, Y20, sep = ""))
```

